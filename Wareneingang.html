<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Wareneingang</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Add DOMPurify -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
  <style>
    /* Custom focus ring for accessibility */
    .focus-ring:focus {
      outline: 2px solid #2563eb;
      outline-offset: 2px;
    }
    /* Visually hidden for screen readers */
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0,0,0,0);
      white-space: nowrap;
      border: 0;
    }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-gray-100 via-blue-50 to-gray-200 p-2 sm:p-5">
  <a href="#mainContent" class="sr-only focus:not-sr-only focus:ring-2 focus:ring-blue-600 bg-white text-blue-700 px-3 py-2 rounded shadow z-50 absolute left-2 top-2">Skip to main content</a>
  <main id="mainContent" class="container mx-auto max-w-3xl bg-white rounded-xl shadow-lg p-4 sm:p-8 mt-4 sm:mt-10">
    <header class="flex items-center mb-6">
      <svg class="w-10 h-10 text-blue-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"></path>
      </svg>
      <h1 class="text-2xl sm:text-3xl font-bold text-gray-900">Wareneingang</h1>
    </header>

    <div id="browserWarning" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4" role="alert" aria-live="assertive">
      <strong class="font-bold">Unsupported Browser! </strong>
      <span class="block sm:inline">This application requires Chrome, Edge, or Opera. Please use a supported browser for full functionality.</span>
    </div>

    <!-- Add restore state banner -->
    <div id="restoreStateBanner" class="hidden bg-blue-100 border border-blue-400 text-blue-700 px-4 py-3 rounded relative mb-4 flex flex-col sm:flex-row justify-between items-start sm:items-center" role="alert" aria-live="polite">
      <div>
        <strong class="font-bold">Previous session found! </strong>
        <span class="block sm:inline" id="restoreStateMessage"></span>
      </div>
      <div class="mt-2 sm:mt-0 flex gap-2">
        <button id="restoreStateButton" class="bg-blue-500 text-white px-4 py-2 rounded focus-ring" aria-label="Restore previous session" type="button">Restore</button>
        <button id="clearStateButton" class="bg-gray-500 text-white px-4 py-2 rounded focus-ring" aria-label="Dismiss restore session banner" type="button">Dismiss</button>
      </div>
    </div>

    <!-- Notification banner with improved structure -->
    <div id="notificationBanner" class="hidden mb-4 rounded relative" role="alert" aria-live="polite">
        <div class="flex items-center p-4">
            <span id="notificationIcon" class="mr-3 text-xl" aria-hidden="true"></span>
            <div class="flex-1">
                <span id="notificationMessage" class="text-sm"></span>
            </div>
            <button onclick="hideNotification()" class="ml-4 text-current opacity-70 hover:opacity-100 focus-ring" aria-label="Close notification" tabindex="0" type="button">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20" aria-hidden="true">
                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                </svg>
                <span class="sr-only">Close notification</span>
            </button>
        </div>
    </div>

    <section class="mb-5">
      <h2 class="text-xl font-semibold mb-3">Negative Gelieferte Menge</h2>
      <div class="flex flex-col sm:flex-row items-stretch sm:items-center gap-4 mb-3">
        <div class="flex-grow">
          <button id="selectFileButton" class="bg-white border border-gray-300 text-gray-700 px-4 py-2 rounded shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 focus-ring w-full sm:w-auto" aria-label="Select TXT File" type="button">
            <svg class="w-5 h-5 inline-block mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"></path>
            </svg>
            Select TXT File
          </button>
          <div id="fileInfo" class="mt-2 text-sm text-gray-600 hidden">
            <div class="flex items-center">
              <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20" aria-hidden="true">
                <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z" clip-rule="evenodd"></path>
              </svg>
              <span id="fileName">No file selected</span>
            </div>
            <div id="fileDetails" class="ml-5 mt-1 text-xs text-gray-500"></div>
          </div>
        </div>
        <div class="flex flex-col sm:flex-row items-start sm:items-center gap-2">
          <label class="inline-flex items-center cursor-pointer">
            <input type="checkbox" id="autoReload" class="form-checkbox focus:ring-2 focus:ring-blue-500 focus:ring-offset-2" aria-label="Enable auto-reload">
            <span class="ml-2">Auto-reload</span>
          </label>
          <span id="monitorStatus" class="ml-2 px-2 py-1 rounded text-sm" aria-live="polite">‚ö™ Idle</span>
          <span id="lastChecked" class="text-xs text-gray-500 hidden">Last checked: <span id="lastCheckedTime"></span></span>
        </div>
      </div>
      <button id="processFileButton" class="bg-blue-500 text-white px-4 py-2 rounded focus-ring w-full sm:w-auto" aria-label="Process File" type="button">Process File</button>
    </section>
  </main>

  <!-- Validation Summary wrapper - new separate section -->
  <div id="validationWrapper" class="container mx-auto max-w-4xl px-2 sm:px-6 mt-6 mb-4">
    <div id="validationSummary" class="w-full bg-white rounded-lg shadow border border-gray-200 p-4"></div>
  </div>

  <!-- Table wrapper outside of main for full width -->
  <div id="tableWrapper" class="w-full max-w-full px-2 sm:px-6 lg:px-12 mx-auto mt-2 mb-8">
    <div class="w-full overflow-x-auto rounded-lg shadow bg-white border border-gray-200">
      <div id="output" class="w-full"></div>
    </div>
  </div>

  <script>
    // Add browser detection at the start
    function isSupported() {
      return 'showOpenFilePicker' in window;
    }

    // Show warning and disable functionality if unsupported
    if (!isSupported()) {
      document.getElementById('browserWarning').classList.remove('hidden');
      document.getElementById('fileInput').disabled = true;
      document.getElementById('autoReload').disabled = true;
      document.getElementById('processFileButton').disabled = true;
    }

    let fileHandle = null;
    let monitorInterval = null;
    let lastModified = null;
    let fileChanged = false;
    let checkInterval = 5000; // Start with 5 seconds
    const maxInterval = 30000; // Max 30 seconds
    const backoffFactor = 1.5;

    // Add persistence handling
    let persistenceGranted = false;

    // Request persistence permission
    async function requestPersistence() {
        try {
            if ('permissions' in navigator) {
                const result = await navigator.permissions.query({ name: 'persistent-storage' });
                if (result.state === 'granted') {
                    persistenceGranted = true;
                    return true;
                }
            }
            
            const granted = await navigator.storage?.persist();
            persistenceGranted = granted;
            return granted;
        } catch (e) {
            console.warn('Persistence not supported:', e);
            return false;
        }
    }

    // Add helper function to check localStorage availability
    function isLocalStorageAvailable() {
        try {
            const test = '__storage_test__';
            localStorage.setItem(test, test);
            localStorage.removeItem(test);
            return true;
        } catch (e) {
            return false;
        }
    }

    // Add error handling utilities at the top after constants
    const ERROR_TYPES = {
        FILE_ACCESS: 'FILE_ACCESS',
        FILE_PROCESSING: 'FILE_PROCESSING',
        STORAGE: 'STORAGE',
        MONITORING: 'MONITORING',
        BROWSER_SUPPORT: 'BROWSER_SUPPORT'
    };

    // Add notification utilities after constants
    const NOTIFICATION_TYPES = {
        INFO: 'INFO',
        SUCCESS: 'SUCCESS',
        WARNING: 'WARNING',
        ERROR: 'ERROR',
        PROCESSING: 'PROCESSING'
    };

    const NOTIFICATION_CONFIGS = {
        [NOTIFICATION_TYPES.INFO]: {
            icon: '‚ÑπÔ∏è',
            classes: 'bg-blue-100 border border-2 border-blue-400 text-blue-700'
        },
        [NOTIFICATION_TYPES.SUCCESS]: {
            icon: '‚úÖ',
            classes: 'bg-green-100 border border-2 border-green-400 text-green-700'
        },
        [NOTIFICATION_TYPES.WARNING]: {
            icon: '‚ö†Ô∏è',
            classes: 'bg-yellow-100 border border-2 border-yellow-400 text-yellow-700'
        },
        [NOTIFICATION_TYPES.ERROR]: {
            icon: '‚ö†Ô∏è',
            classes: 'bg-red-100 border border-2 border-red-400 text-red-700'
        },
        [NOTIFICATION_TYPES.PROCESSING]: {
            icon: 'üîÑ',
            classes: 'bg-blue-100 border border-2 border-blue-400 text-blue-700'
        }
    };

    function showNotification(message, type = NOTIFICATION_TYPES.INFO, duration = 5000) {
        const banner = document.getElementById('notificationBanner');
        const icon = document.getElementById('notificationIcon');
        const messageElement = document.getElementById('notificationMessage');
        
        // Hide any existing notifications first
        banner.classList.add('hidden');
        
        // Clear previous classes and set new ones
        banner.className = 'mb-4 rounded relative';
        
        // Get config for notification type
        const config = NOTIFICATION_CONFIGS[type] || NOTIFICATION_CONFIGS[NOTIFICATION_TYPES.INFO];
        
        // Apply styling from config
        banner.classList.add(...config.classes.split(' '));
        
        // Set icon and message
        icon.textContent = config.icon || '‚ÑπÔ∏è';
        icon.className = 'mr-3 text-xl';
        messageElement.textContent = message;
        
        // Show the banner
        banner.classList.remove('hidden');

        // Auto-hide if duration is specified
        if (duration > 0) {
            // Clear any existing timeout
            if (window.notificationTimeout) {
                clearTimeout(window.notificationTimeout);
            }
            window.notificationTimeout = setTimeout(hideNotification, duration);
        }
    }

    function hideNotification() {
        document.getElementById('notificationBanner').classList.add('hidden');
    }

    // Modify handleError to use notification system
    function handleError(error, type, silent = false) {
        // Always log to console
        console.error(`[${type}]`, error);

        // Determine user-friendly message
        let userMessage = 'An unexpected error occurred.';
        if (error instanceof Error) {
            switch (type) {
                case ERROR_TYPES.FILE_ACCESS:
                    userMessage = `Cannot access file: ${error.message}`;
                    break;
                case ERROR_TYPES.FILE_PROCESSING:
                    userMessage = `Error processing file: ${error.message}`;
                    break;
                case ERROR_TYPES.STORAGE:
                    userMessage = `Storage error: ${error.message}`;
                    break;
                case ERROR_TYPES.MONITORING:
                    userMessage = `File monitoring error: ${error.message}`;
                    break;
                case ERROR_TYPES.BROWSER_SUPPORT:
                    userMessage = `Browser compatibility error: ${error.message}`;
                    break;
            }
        } else if (typeof error === 'string') {
            userMessage = error;
        }

        // Show notification unless silent
        if (!silent) {
            showNotification(userMessage, NOTIFICATION_TYPES.ERROR);
        }

        return { type, message: userMessage, error };
    }

    // Modified saveState function with standardized error handling
    function saveState() {
        if (!fileHandle || !isLocalStorageAvailable()) return;
        
        const state = {
            monitoring: !!monitorInterval,
            lastModified: lastModified,
            fileName: fileHandle.name,
            filePath: fileHandle.name
        };

        try {
            localStorage.setItem('fileProcessor', JSON.stringify(state));
        } catch (e) {
            const error = handleError(e, ERROR_TYPES.STORAGE, true);
            
            if (e.name === 'QuotaExceededError' || 
                e.name === 'NS_ERROR_DOM_QUOTA_REACHED') {
                try {
                    localStorage.removeItem('fileProcessor');
                    localStorage.setItem('fileProcessor', JSON.stringify(state));
                    return;
                } catch (retryError) {
                    handleError(retryError, ERROR_TYPES.STORAGE, true);
                }
            }

            // Show error in status
            const status = document.getElementById('monitorStatus');
            status.textContent = '‚ö†Ô∏è Storage Error';
            status.className = 'ml-2 px-2 py-1 rounded text-sm bg-red-100';
            setTimeout(() => {
                if (monitorInterval) {
                    status.textContent = 'üü¢ Monitoring';
                    status.className = 'ml-2 px-2 py-1 rounded text-sm bg-green-100';
                } else {
                    status.textContent = '‚ö™ Idle';
                    status.className = 'ml-2 px-2 py-1 rounded text-sm';
                }
            }, 3000);
        }
    }

    // Modified loadState function with path suggestion
    async function loadState() {
        const saved = localStorage.getItem('fileProcessor');
        if (!saved) return;

        const state = JSON.parse(saved);
        
        if (state.monitoring || state.filePath) {
            const banner = document.getElementById('restoreStateBanner');
            const message = document.getElementById('restoreStateMessage');
            const safeMessage = state.monitoring ? 
                `Resume monitoring "${DOMPurify.sanitize(state.filePath)}"?` :
                `Last used file: "${DOMPurify.sanitize(state.filePath)}"`;
            message.textContent = '';
            const span = document.createElement('span');
            span.className = 'font-mono text-xs bg-gray-100 px-1';
            span.textContent = state.filePath;
            message.appendChild(document.createTextNode(state.monitoring ? 'Resume monitoring "' : 'Last used file: "'));
            message.appendChild(span);
            message.appendChild(document.createTextNode('"'));

            banner.classList.remove('hidden');

            document.getElementById('restoreStateButton').onclick = async () => {
                try {
                    const handles = await window.showOpenFilePicker({
                        types: [{
                            description: 'MHTML Files',
                            accept: {
                                'multipart/related': ['.mhtml', '.MHTML']
                            }
                        }],
                        multiple: false,
                        startIn: 'downloads' // Try to start in downloads folder
                    });
                    
                    fileHandle = handles[0];
                    const file = await fileHandle.getFile();
                    
                    if (state.monitoring) {
                        if (file.name === state.fileName) {
                            // ... existing monitoring restoration code ...
                            lastModified = file.lastModified;
                            document.getElementById('output').innerHTML = 
                                DOMPurify.sanitize(`<p class="text-gray-500">File selected: ${file.name}<br>Last modified: ${new Date(lastModified).toLocaleString()}</p>`);
                            
                            document.getElementById('autoReload').checked = true;
                            const status = document.getElementById('monitorStatus');
                            status.innerHTML = 'üü¢ Monitoring';
                            status.className = 'ml-2 px-2 py-1 rounded text-sm bg-green-100';
                            updateTitle('üü¢ Monitoring');
                            monitorInterval = setInterval(checkFileChanges, 1000);
                            
                            const text = await file.text();
                            processFile(text.trim());
                            banner.classList.add('hidden');
                        } else {
                            showNotification('Different file selected. Monitoring not resumed.', NOTIFICATION_TYPES.WARNING);
                            // But still save the new file as current
                            await handleSelectedFile(file);
                        }
                    } else {
                        await handleSelectedFile(file);
                    }
                    banner.classList.add('hidden');
                    
                } catch (err) {
                    console.error('Error restoring state:', err);
                    showNotification('Failed to restore state', NOTIFICATION_TYPES.ERROR);
                    localStorage.removeItem('fileProcessor');
                    banner.classList.add('hidden');
                }
            };

            // Update restore button text based on state
            document.getElementById('restoreStateButton').textContent = 
                state.monitoring ? 'Restore Monitoring' : 'Open Last File';

            document.getElementById('clearStateButton').onclick = () => {
                localStorage.removeItem('fileProcessor');
                banner.classList.add('hidden');
            };
        }
    }

    // New helper function to handle selected file
    async function handleSelectedFile(file) {
        lastModified = file.lastModified;
        
        // Update file info display safely
        document.getElementById('fileInfo').classList.remove('hidden');
        document.getElementById('fileName').textContent = file.name;
        const details = document.getElementById('fileDetails');
        details.textContent = '';
        
        const lastMod = document.createElement('div');
        lastMod.textContent = `Last modified: ${new Date(lastModified).toLocaleString()}`;
        const size = document.createElement('div');
        size.textContent = `Size: ${(file.size / 1024).toFixed(2)} KB`;
        
        details.appendChild(lastMod);
        details.appendChild(size);
        
        const text = await file.text();
        processFile(text.trim());
        saveState();
    }

    // Modified initialization
    async function initialize() {
        if (isSupported()) {
            const granted = await requestPersistence();
            console.log('Persistence granted:', granted);
            await loadState();
        } else {
            // ...existing browser warning code...
        }
    }
    
    // Run initialization
    initialize();

    // Update file picker handler to use handleSelectedFile
    document.getElementById('selectFileButton').addEventListener('click', async function () {
        try {
            const handles = await window.showOpenFilePicker({
                types: [{
                    description: 'MHTML Files',
                    accept: {
                        'application/x-mimearchive': ['.mhtml', '.mht'],
                        'message/rfc822': ['.mhtml', '.mht']
                    }
                }],
                multiple: false,
                startIn: 'downloads' // Try to start in downloads folder
            });
            
            fileHandle = handles[0];
            const file = await fileHandle.getFile();
            await handleSelectedFile(file);
            
        } catch (err) {
            if (err.name !== 'AbortError') {
                handleError(err, ERROR_TYPES.FILE_ACCESS);
            }
        }
    });

    // Add helper function for cleaning up monitoring state
    function cleanupMonitoringState() {
        clearInterval(monitorInterval);
        monitorInterval = null;

        // Reset UI state
        document.getElementById('monitorStatus').textContent = '‚ö™ Idle';
        document.getElementById('lastChecked').classList.add('hidden');

        const autoReload = document.getElementById('autoReload');
        autoReload.checked = false;

        const fileInfo = document.getElementById('fileInfo');
        fileInfo.classList.add('hidden');

        document.getElementById('fileName').textContent = 'No file selected';
        document.getElementById('fileDetails').textContent = '';

        // Clear output
        const output = document.getElementById('output');
        output.textContent = '';

        // Reset interval
        checkInterval = 5000;

        // Reset file-related state
        fileHandle = null;
        lastModified = null;
        fileChanged = false;
    }

    async function checkFileChanges() {
        try {
            if (!fileHandle) return;
            
            const file = await fileHandle.getFile();
            
            // Update last checked timestamp
            document.getElementById('lastChecked').classList.remove('hidden');
            document.getElementById('lastCheckedTime').textContent = new Date().toLocaleTimeString();
            
            if (file.lastModified > lastModified) {
                fileChanged = true;
                lastModified = file.lastModified;
                const text = await file.text();
                processFile(text.trim());
                
                // Visual feedback
                const status = document.getElementById('monitorStatus');
                status.textContent = `üîÑ Updated: ${new Date().toLocaleTimeString()}`;
                status.className = 'ml-2 px-2 py-1 rounded text-sm bg-yellow-100';
                updateTitle('üîÑ Updated');
                
                setTimeout(() => {
                    status.textContent = 'üü¢ Monitoring';
                    status.className = 'ml-2 px-2 py-1 rounded text-sm bg-green-100';
                    updateTitle('üü¢ Monitoring');
                }, 1000);
            } else {
                fileChanged = false;
            }
        } catch (err) {
            const error = handleError(err, ERROR_TYPES.MONITORING);
            cleanupMonitoringState();
            
            const status = document.getElementById('monitorStatus');
            status.textContent = '‚ö†Ô∏è Error';
            status.className = 'ml-2 px-2 py-1 rounded text-sm bg-red-100';
            updateTitle('‚ö†Ô∏è Error');
            
            throw error;
        }
    }
    
    function cleanupMonitoringState() {
        clearInterval(monitorInterval);
        monitorInterval = null;
        
        // Reset UI state
        document.getElementById('monitorStatus').textContent = '‚ö™ Idle';
        document.getElementById('lastChecked').classList.add('hidden');
        
        const autoReload = document.getElementById('autoReload');
        autoReload.checked = false;
        
        const fileInfo = document.getElementById('fileInfo');
        fileInfo.classList.add('hidden');
        
        document.getElementById('fileName').textContent = 'No file selected';
        document.getElementById('fileDetails').textContent = '';
        
        // Clear output
        const output = document.getElementById('output');
        output.textContent = '';
        
        // Reset interval
        checkInterval = 5000;
    }

    function setupMonitoring() {
        if (monitorInterval) {
            clearInterval(monitorInterval);
        }

        monitorInterval = setInterval(() => {
            checkFileChanges();
            // Increase interval up to maxInterval if no changes detected
            if (!fileChanged) {
                checkInterval = Math.min(checkInterval * backoffFactor, maxInterval);
                clearInterval(monitorInterval);
                monitorInterval = setInterval(arguments.callee, checkInterval);
            } else {
                // Reset interval to 5 seconds when changes are detected
                checkInterval = 5000;
                clearInterval(monitorInterval);
                monitorInterval = setInterval(arguments.callee, checkInterval);
            }
        }, checkInterval);
    }

    // Update process file button
    document.getElementById('processFileButton').addEventListener('click', async function () {
        if (!fileHandle) {
            showNotification('Please select a file first!', NOTIFICATION_TYPES.WARNING);
            return;
        }

        try {
            const file = await fileHandle.getFile();
            const text = await file.text();
            processFile(text.trim());
        } catch (err) {
            handleError(err, ERROR_TYPES.FILE_ACCESS);
        }
    });

    // Modified auto-reload toggle
    document.getElementById('autoReload').addEventListener('change', function(e) {
        const status = document.getElementById('monitorStatus');
        if (e.target.checked) {
            if (!fileHandle) {
                showNotification('Please select a file first!', NOTIFICATION_TYPES.WARNING);
                e.target.checked = false;
                return;
            }
            status.innerHTML = 'üü¢ Monitoring';
            status.className = 'ml-2 px-2 py-1 rounded text-sm bg-green-100';
            updateTitle('üü¢ Monitoring');
            checkInterval = 5000; // Reset interval when starting monitoring
            setupMonitoring();
            saveState();
        } else {
            status.innerHTML = '‚ö™ Idle';
            status.className = 'ml-2 px-2 py-1 rounded text-sm';
            updateTitle();
            if (monitorInterval) {
                clearInterval(monitorInterval);
            }
            saveState();
        }
    });

    // Add beforeunload handler
    window.addEventListener('beforeunload', () => {
        if (monitorInterval) {
            saveState();
        }
    });

    // Replace complex column configuration with just the required filter column
    const DELIVERED_QUANTITY_COLUMN = 'Gelieferte Menge';

    // New function to update title
    function updateTitle(status) {
        const baseTitle = 'Wareneingang';
        document.title = status ? `${baseTitle} (${status})` : baseTitle;
    }

    // Modified generateValidationSummary function for better responsiveness
    function generateValidationSummary({totalRows, zeroRows, negativeRows, invalidValues, columnName}) {
        return `
            <div class="mb-2">
                <h3 class="font-bold text-lg">Validation Summary</h3>
                <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 mt-2">
                    <div class="bg-gray-100 p-3 rounded shadow-sm">
                        <div class="text-sm text-gray-500">Total Rows</div>
                        <div class="text-xl font-bold">${totalRows}</div>
                    </div>
                    <div class="bg-blue-100 p-3 rounded shadow-sm">
                        <div class="text-sm text-blue-500">Zero Quantities</div>
                        <div class="text-xl font-bold">${zeroRows}</div>
                    </div>
                    <div class="bg-red-100 p-3 rounded shadow-sm">
                        <div class="text-sm text-red-500">Negative Quantities</div>
                        <div class="text-xl font-bold">${negativeRows}</div>
                    </div>
                    <div class="bg-yellow-100 p-3 rounded shadow-sm">
                        <div class="text-sm text-yellow-500">Invalid Values</div>
                        <div class="text-xl font-bold">${invalidValues}</div>
                    </div>
                </div>
            </div>
            ${invalidValues > 0 ? 
                `<div class="bg-yellow-50 border-l-4 border-yellow-400 p-2 text-yellow-700 mt-2">
                    <p>Warning: ${invalidValues} invalid numeric values found in '${columnName}' column</p>
                </div>` : ''
            }
            ${zeroRows === 0 && negativeRows === 0 ? 
                `<div class="bg-green-50 border-l-4 border-green-400 p-2 text-green-700 mt-2">
                    <p>No zero or negative quantities found in '${columnName}' column</p>
                </div>` : ''
            }
        `;
    }

    // New function to create table header
    function createTableHeader(headers) {
        const fragment = document.createDocumentFragment();
        const thead = document.createElement('thead');
        const headerRow = document.createElement('tr');
        headerRow.className = 'bg-gray-200';
        
        // Add empty header for dot column
        const emptyHeader = document.createElement('th');
        emptyHeader.className = 'border border-gray-400 px-2 py-1';
        headerRow.appendChild(emptyHeader);
        
        // Add regular headers
        headers.forEach(header => {
            const th = document.createElement('th');
            th.className = 'border border-gray-400 px-2 py-1';
            th.textContent = header;
            headerRow.appendChild(th);
        });
        
        thead.appendChild(headerRow);
        fragment.appendChild(thead);
        return fragment;
    }
    
    // New function to create table body
    function createTableBody(filteredData, headers, gelieferteMengeIndex) {
        const fragment = document.createDocumentFragment();
        const tbody = document.createElement('tbody');
        
        filteredData.forEach(rowData => {
            const tr = document.createElement('tr');
            
            // Add dot at the start of each row
            const dotTd = document.createElement('td');
            if (rowData.type === 'zero') {
                tr.className = 'bg-blue-50 hover:bg-blue-100 transition-colors';
                dotTd.innerHTML = DOMPurify.sanitize('<span class="inline-block w-4 h-4 rounded-full bg-blue-500 mr-2"></span>');
            } else {
                tr.className = 'bg-red-50 hover:bg-red-100 transition-colors';
                dotTd.innerHTML = DOMPurify.sanitize('<span class="inline-block w-4 h-4 rounded-full bg-red-500 mr-2"></span>');
            }
            dotTd.className = 'pl-3 py-1';
            tr.appendChild(dotTd);
            
            rowData.cells.forEach((cell, index) => {
                const td = document.createElement('td');
                const isNumber = !isNaN(parseFloat(cell.replace(',', '.')));
                let cellClass = `border border-gray-300 px-2 py-1 ${isNumber ? 'text-right' : 'text-left'}`;
                
                // Highlight the quantity column
                if (index === gelieferteMengeIndex) {
                    if (rowData.type === 'zero') {
                        cellClass += ' font-bold text-blue-700';
                    } else {
                        cellClass += ' font-bold text-red-700';
                    }
                }
                
                td.className = cellClass;
                td.textContent = cell;
                tr.appendChild(td);
            });
            tbody.appendChild(tr);
        });
        
        fragment.appendChild(tbody);
        return fragment;
    }
    
    // Modified processFile function with HTML content validation
    async function processFile(rawData) {
        showNotification('Processing file...', NOTIFICATION_TYPES.PROCESSING, 0);
        
        try {
            // Clear previous results
            const output = document.getElementById('output');
            output.innerHTML = '';
            
            // Get validation summary element
            const validationSummary = document.getElementById('validationSummary');
            validationSummary.innerHTML = '';
            
            // Find the HTML content section in MHTML
            const htmlStart = rawData.indexOf('<html');
            
            if (htmlStart === -1) {
                throw new Error('No HTML content found in file. Please ensure this is a valid MHTML file.');
            }
            
            const htmlContent = rawData.substring(htmlStart);
            
            // Sanitize and parse the HTML content
            const sanitizedHtml = DOMPurify.sanitize(htmlContent, {
                WHOLE_DOCUMENT: true,
                RETURN_DOM: false,
                USE_PROFILES: { html: true, svg: false, svgFilters: false }
            });
            
            const parser = new DOMParser();
            const doc = parser.parseFromString(sanitizedHtml, 'text/html');
            
            if (!doc.querySelector('table') && !doc.querySelector('tr')) {
                throw new Error('Invalid file format: No table data found after sanitization');
            }

            // Find the table rows
            const rows = doc.querySelectorAll('tr');
            if (!rows.length) {
                throw new Error('No table data found');
            }

            // Extract headers
            const headers = Array.from(rows[0].querySelectorAll('td')).map(td => td.textContent.trim());
            
            // Find required column
            const gelieferteMengeIndex = headers.indexOf(DELIVERED_QUANTITY_COLUMN);
            if (gelieferteMengeIndex === -1) {
                showNotification(`Required column '${DELIVERED_QUANTITY_COLUMN}' not found!`, NOTIFICATION_TYPES.ERROR);
                validationSummary.innerHTML = `<div class="text-red-600 font-bold">Error: Required column '${DELIVERED_QUANTITY_COLUMN}' not found in file</div>`;
                return;
            }

            // Process data rows and collect stats
            let totalRows = 0;
            let zeroRows = 0;
            let negativeRows = 0;
            let invalidValues = 0;
            
            const filteredData = Array.from(rows)
                .slice(1)
                .map(row => {
                    totalRows++;
                    const cells = Array.from(row.querySelectorAll('td')).map(td => td.textContent.trim());
                    if (!cells[gelieferteMengeIndex]) return null;
                    
                    const value = parseFloat(cells[gelieferteMengeIndex].replace(',', '.'));
                    if (isNaN(value)) {
                        invalidValues++;
                        return null;
                    }
                    
                    if (value === 0) {
                        zeroRows++;
                        return {cells, type: 'zero'};
                    } else if (value < 0) {
                        negativeRows++;
                        return {cells, type: 'negative'};
                    }
                    
                    return null;
                })
                .filter(row => row !== null);

            // Update validation summary in its dedicated wrapper
            validationSummary.innerHTML = DOMPurify.sanitize(generateValidationSummary({
                totalRows,
                zeroRows,
                negativeRows,
                invalidValues,
                columnName: DELIVERED_QUANTITY_COLUMN
            }));
            
            if (zeroRows === 0 && negativeRows === 0) {
                showNotification('No zero or negative quantities found', NOTIFICATION_TYPES.INFO);
                return;
            }
            
            // Generate table with filtered data
            const table = document.createElement('table');
            table.className = 'min-w-full w-full border-collapse text-sm md:text-base bg-white';
            
            table.appendChild(createTableHeader(headers));
            table.appendChild(createTableBody(filteredData, headers, gelieferteMengeIndex));
            
            output.appendChild(table);
            
            showNotification(`Found ${zeroRows} zero and ${negativeRows} negative quantities`, NOTIFICATION_TYPES.SUCCESS);
            
        } catch (error) {
            // Update the validation summary to show the error
            const validationSummary = document.getElementById('validationSummary');
            validationSummary.innerHTML = DOMPurify.sanitize(`
                <div class="bg-red-50 border-l-4 border-red-400 p-4 text-red-700">
                    <p class="font-bold">Error Processing File</p>
                    <p>${error.message}</p>
                </div>
            `);
            
            showNotification(`Error processing file: ${error.message}`, NOTIFICATION_TYPES.ERROR);
            throw error;
        }
    }
  </script>
</body>
</html>
