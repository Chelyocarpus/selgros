<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Wareneingang</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
  <link rel="stylesheet" href="css/main.css">
  <link rel="stylesheet" href="css/animations.css">
</head>
<body>
  <!-- Skip link -->
  <a href="#mainContent"
     class="skip-link sr-only focus:not-sr-only fixed left-3 top-3 z-50 bg-white text-zinc-900 font-semibold px-4 py-2 rounded-lg">
    Zum Hauptinhalt springen
  </a>

  <!-- Page wrapper -->
  <div class="relative z-10 min-h-screen px-2 py-6 sm:px-3 sm:py-10">

    <!-- Main upload card -->
    <main id="mainContent"
          class="card-glass mx-auto max-w-3xl">

      <!-- App header -->
      <header class="app-header px-6 py-7 sm:px-8 sm:py-9 mb-0">
        <div class="relative z-10 flex items-center gap-4">
          <!-- Icon badge -->
          <div class="header-icon-badge">
            <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" stroke-width="1.75" viewBox="0 0 24 24" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
            </svg>
          </div>
          <div>
            <h1 class="text-2xl sm:text-3xl font-extrabold text-white tracking-tight">Wareneingang</h1>
            <p class="text-zinc-400 text-sm mt-0.5 font-medium">Anomalie-Erkennung &amp; Analyse</p>
          </div>
        </div>
      </header>

      <!-- Card body -->
      <div class="px-6 py-7 sm:px-8 sm:py-8">

        <!-- Browser warning -->
        <div id="browserWarning"
             class="hidden notification-bar notification-bar--error mb-6 px-4 py-3"
             role="alert" aria-live="assertive">
          <div class="flex items-start gap-3">
            <svg class="w-5 h-5 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20" aria-hidden="true">
              <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
            </svg>
            <div>
              <p class="font-semibold text-sm">Nicht unterstützter Browser</p>
              <p class="text-sm mt-0.5 opacity-85">Bitte wechseln Sie zu Chrome, Edge oder Opera. Ihr aktueller Browser unterstützt die File System Access API nicht, die für die Dateiverarbeitung benötigt wird.</p>
            </div>
          </div>
        </div>

        <!-- Notification banner -->
        <div id="notificationBanner"
             class="hidden notification-bar mb-6"
             role="alert" aria-live="polite">
          <div class="flex items-center gap-3 px-4 py-3">
            <span id="notificationIcon" aria-hidden="true" class="flex-shrink-0 w-5 h-5"></span>
            <span id="notificationMessage" class="flex-1 text-sm font-medium"></span>
            <button onclick="hideNotification()"
                    class="notification-close flex-shrink-0 p-1 rounded opacity-60 hover:opacity-100"
                    aria-label="Benachrichtigung schließen" type="button">
              <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20" aria-hidden="true">
                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
              </svg>
              <span class="sr-only">Benachrichtigung schließen</span>
            </button>
          </div>
        </div>

        <!-- File processing section -->
        <section class="mb-2" aria-labelledby="fileProcessingHeading">
          <h2 id="fileProcessingHeading" class="section-heading text-base font-semibold mb-4">Dateiverarbeitung</h2>

          <input type="file" id="fileInput" accept=".mhtml,.mht" class="sr-only" aria-label="MHTML-Datei auswählen" />

          <!-- Drop zone -->
          <button id="selectFileButton"
                  class="drop-zone w-full px-6 py-10 text-center"
                  type="button"
                  aria-label="MHTML-Datei auswählen oder hierher ziehen">
            <div class="flex flex-col items-center gap-3">
              <div class="drop-zone-icon">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="1.75" viewBox="0 0 24 24" aria-hidden="true">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
                </svg>
              </div>
              <div>
                <span class="drop-zone-label block text-sm font-semibold">MHTML-Datei auswählen</span>
                <span class="drop-zone-hint block text-xs mt-0.5">oder hierher ziehen &mdash; .mhtml, .mht</span>
              </div>
            </div>
          </button>

          <!-- Selected file pill -->
          <div id="selectedFileName"
               class="file-selected hidden mt-3 flex items-center gap-2 px-4 py-2.5">
            <svg class="w-4 h-4 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20" aria-hidden="true">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
            </svg>
            <span id="fileName" class="file-selected-name text-sm font-medium truncate">Keine Datei ausgewählt</span>
          </div>

          <!-- Process button -->
          <div class="mt-5 flex justify-center">
            <button id="processFileButton"
                    class="btn-primary"
                    aria-label="Ausgewählte Datei verarbeiten"
                    type="button"
                    disabled>
              <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/>
              </svg>
              Datei verarbeiten
            </button>
          </div>
        </section>

      </div><!-- /card body -->
    </main>

    <!-- Validation Summary -->
    <div id="validationWrapper" class="hidden mx-auto mt-6 mb-4">
      <div id="validationSummary" class="card-glass px-6 py-6 sm:px-8 sm:py-7"></div>
    </div>

    <!-- Table wrapper -->
    <div id="tableWrapper" class="hidden mx-auto mt-4 mb-10">
      <div class="card-glass overflow-hidden">
        <div id="output" class="w-full overflow-x-auto"></div>
      </div>
    </div>

  </div><!-- /page wrapper -->

  <script>
    // Configuration object for better maintainability
    const CONFIG = {
      NOTIFICATION_DURATION: 5000,
      DELIVERED_QUANTITY_COLUMN: 'Offene Menge L/A',
      // Lazy loading configuration
      ROWS_PER_PAGE: 100,
      INITIAL_LOAD: 200,
      // Performance configuration
      DEBOUNCE_DELAY: 100, // Reduced for better real-time feedback
      LAZY_LOAD_DELAY: 0, // Removed artificial delay for better performance
      // Intersection Observer configuration (responsive to viewport)
      getIntersectionMargin() {
        // Use smaller margin on mobile for better performance
        const isMobile = window.innerWidth < 768;
        return isMobile ? '50px' : '100px';
      },
      // Filter configuration
      FILTER_OUT_UNITS: ['kg', 'KG', 'Kg'], // Units to filter out
      LOG_LEVELS: {
        DEBUG: 0,
        INFO: 1,
        WARN: 2,
        ERROR: 3
      },
      CURRENT_LOG_LEVEL: 1 // INFO level by default
    };

    // Logging utility with configurable levels
    const Logger = {
      debug: (message, ...args) => {
        if (CONFIG.CURRENT_LOG_LEVEL <= CONFIG.LOG_LEVELS.DEBUG) {
          console.debug(`[DEBUG] ${message}`, ...args);
        }
      },
      info: (message, ...args) => {
        if (CONFIG.CURRENT_LOG_LEVEL <= CONFIG.LOG_LEVELS.INFO) {
          console.info(`[INFO] ${message}`, ...args);
        }
      },
      warn: (message, ...args) => {
        if (CONFIG.CURRENT_LOG_LEVEL <= CONFIG.LOG_LEVELS.WARN) {
          console.warn(`[WARN] ${message}`, ...args);
        }
      },
      error: (message, ...args) => {
        if (CONFIG.CURRENT_LOG_LEVEL <= CONFIG.LOG_LEVELS.ERROR) {
          console.error(`[ERROR] ${message}`, ...args);
        }
      }
    };

    // Debounced function utility
    const debounce = (func, wait) => {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    };

    // Browser detection with improved accessibility
    const isSupported = () => {
      return 'showOpenFilePicker' in window;
    };

    // Show warning and disable functionality if unsupported
    if (!isSupported()) {
      const browserWarning = document.getElementById('browserWarning');
      const processFileButton = document.getElementById('processFileButton');
      
      if (browserWarning) {
        browserWarning.classList.remove('hidden');
      }
      if (processFileButton) {
        processFileButton.disabled = true;
      }
      Logger.error('Browser not supported - missing File System Access API');
    }

    // Application state management
    const AppState = {
      fileHandle: null,
      currentFilteredData: [],
      currentHeaders: [],
      currentTargetColumnIndex: -1,
      // Lazy loading state
      displayedRows: 0,
      totalFilteredRows: 0,
      isLoading: false,
      currentlyDisplayedData: []
    };

    // Error types configuration
    const ERROR_TYPES = {
      FILE_ACCESS: 'FILE_ACCESS',
      FILE_PROCESSING: 'FILE_PROCESSING',
      BROWSER_SUPPORT: 'BROWSER_SUPPORT'
    };

    // Notification types and configurations
    const NOTIFICATION_TYPES = {
      INFO: 'INFO',
      SUCCESS: 'SUCCESS',
      WARNING: 'WARNING',
      ERROR: 'ERROR',
      PROCESSING: 'PROCESSING'
    };

    const NOTIFICATION_ICONS = {
      INFO: `<svg class="notification-icon-svg" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>`,
      SUCCESS: `<svg class="notification-icon-svg" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>`,
      WARNING: `<svg class="notification-icon-svg" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>`,
      ERROR: `<svg class="notification-icon-svg" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>`,
      PROCESSING: `<svg class="notification-icon-svg animate-spin" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>`
    };

    const NOTIFICATION_CONFIGS = {
      [NOTIFICATION_TYPES.INFO]:       { icon: NOTIFICATION_ICONS.INFO,       cssClass: 'notification-bar--info' },
      [NOTIFICATION_TYPES.SUCCESS]:    { icon: NOTIFICATION_ICONS.SUCCESS,    cssClass: 'notification-bar--success' },
      [NOTIFICATION_TYPES.WARNING]:    { icon: NOTIFICATION_ICONS.WARNING,    cssClass: 'notification-bar--warning' },
      [NOTIFICATION_TYPES.ERROR]:      { icon: NOTIFICATION_ICONS.ERROR,      cssClass: 'notification-bar--error' },
      [NOTIFICATION_TYPES.PROCESSING]: { icon: NOTIFICATION_ICONS.PROCESSING, cssClass: 'notification-bar--processing' }
    };

    // Notification system with improved UX
    const NotificationManager = {
      timeout: null,

      show(message, type = NOTIFICATION_TYPES.INFO, duration = CONFIG.NOTIFICATION_DURATION) {
        const { banner, icon, messageElement } = this.getElements();
        
        // Hide any existing notifications first
        banner.classList.add('hidden');
        
        // Get config for notification type
        const config = NOTIFICATION_CONFIGS[type] || NOTIFICATION_CONFIGS[NOTIFICATION_TYPES.INFO];
        
        // Apply CSS class for notification type
        banner.className = `notification-bar mb-6 ${config.cssClass}`;
        
        // Set SVG icon
        icon.innerHTML = DOMPurify.sanitize(config.icon || NOTIFICATION_ICONS.INFO);
        messageElement.textContent = message;
        
        // Show the banner
        banner.classList.remove('hidden');

        // Auto-hide if duration is specified
        if (duration > 0) {
          this.clearTimeout();
          this.timeout = setTimeout(() => this.hide(), duration);
        }
      },

      hide() {
        const { banner } = this.getElements();
        banner.classList.add('hidden');
        this.clearTimeout();
      },

      clearTimeout() {
        if (this.timeout) {
          clearTimeout(this.timeout);
          this.timeout = null;
        }
      },

      getElements() {
        return {
          banner: document.getElementById('notificationBanner'),
          icon: document.getElementById('notificationIcon'),
          messageElement: document.getElementById('notificationMessage')
        };
      }
    };

    // Legacy function for backward compatibility
    const showNotification = (message, type, duration) => NotificationManager.show(message, type, duration);
    const hideNotification = () => NotificationManager.hide();

    // Error handling with improved logging and user feedback
    const ErrorHandler = {
      handle(error, type, silent = false) {
        // Always log to console with appropriate level
        Logger.error(`[${type}]`, error);

        // Determine user-friendly message
        let userMessage = 'An unexpected error occurred.';
        if (error instanceof Error) {
          const { message } = error;
          switch (type) {
            case ERROR_TYPES.FILE_ACCESS:
              userMessage = `Cannot access file: ${message}`;
              break;
            case ERROR_TYPES.FILE_PROCESSING:
              userMessage = `Error processing file: ${message}`;
              break;
            case ERROR_TYPES.BROWSER_SUPPORT:
              userMessage = `Browser compatibility error: ${message}`;
              break;
          }
        } else if (typeof error === 'string') {
          userMessage = error;
        }

        // Show notification unless silent
        if (!silent) {
          NotificationManager.show(userMessage, NOTIFICATION_TYPES.ERROR);
        }

        return { type, message: userMessage, error };
      }
    };

    // File handling with improved structure
    const FileHandler = {
      async handleSelectedFile(file) {
        try {
          const text = await file.text();
          await FileProcessor.processFile(text.trim());
          
          Logger.info('File processed successfully:', file.name);
        } catch (error) {
          ErrorHandler.handle(error, ERROR_TYPES.FILE_PROCESSING);
        }
      }
    };

    // Application initialization with improved structure
    const AppInitializer = {
      async init() {
        if (isSupported()) {
          Logger.info('Browser supported for File System Access API');
        } else {
          Logger.error('Browser not supported');
        }
        
        // Hide empty elements on page load
        this.hideEmptyElements();
      },
      
      hideEmptyElements() {
        const validationWrapper = document.getElementById('validationWrapper');
        const tableWrapper = document.getElementById('tableWrapper');
        
        if (validationWrapper) {
          validationWrapper.classList.add('hidden');
        }
        if (tableWrapper) {
          tableWrapper.classList.add('hidden');
        }
      }
    };
    
    // Initialize application
    AppInitializer.init();

    // Event handlers with improved structure and error handling
    const EventHandlers = {
      async handleFileSelection() {
        try {
          const handles = await window.showOpenFilePicker({
            types: [{
              description: 'MHTML Files',
              accept: {
                'application/x-mimearchive': ['.mhtml', '.mht'],
                'message/rfc822': ['.mhtml', '.mht']
              }
            }],
            multiple: false,
            startIn: 'downloads'
          });
          
          AppState.fileHandle = handles[0];
          const file = await AppState.fileHandle.getFile();
          
          // Update UI to show selected file
          this.updateFileSelection(file.name);
          
          await FileHandler.handleSelectedFile(file);
          
        } catch (err) {
          if (err.name !== 'AbortError') {
            ErrorHandler.handle(err, ERROR_TYPES.FILE_ACCESS);
          }
        }
      },

      handleFileInputChange(event) {
        const file = event.target.files[0];
        if (file) {
          this.updateFileSelection(file.name);
          FileHandler.handleSelectedFile(file);
        }
      },

      updateFileSelection(fileName) {
        const fileNameElement = document.getElementById('fileName');
        const selectedFileNameDiv = document.getElementById('selectedFileName');
        const processButton = document.getElementById('processFileButton');
        
        if (fileNameElement && selectedFileNameDiv && processButton) {
          fileNameElement.textContent = fileName;
          selectedFileNameDiv.classList.remove('hidden');
          processButton.disabled = false;
          processButton.classList.remove('opacity-50', 'cursor-not-allowed');
        }
      },

      async handleProcessFile() {
        if (!AppState.fileHandle) {
          NotificationManager.show('Please select a file first!', NOTIFICATION_TYPES.WARNING);
          return;
        }

        try {
          const file = await AppState.fileHandle.getFile();
          const text = await file.text();
          await FileProcessor.processFile(text.trim());
        } catch (err) {
          ErrorHandler.handle(err, ERROR_TYPES.FILE_ACCESS);
        }
      }
    };

    // Filter state persistence using localStorage
    const FilterPersistence = {
      STORAGE_KEY: 'wareneingang_filters',

      save({ showZero, showNegative, showPositive }) {
        try {
          localStorage.setItem(this.STORAGE_KEY, JSON.stringify({ showZero, showNegative, showPositive }));
        } catch (e) {
          Logger.warn('Could not save filter state', e);
        }
      },

      load() {
        try {
          const saved = localStorage.getItem(this.STORAGE_KEY);
          if (saved) {
            const { showZero, showNegative, showPositive } = JSON.parse(saved);
            return {
              showZero: showZero ?? true,
              showNegative: showNegative ?? true,
              showPositive: showPositive ?? true
            };
          }
        } catch (e) {
          Logger.warn('Could not load filter state', e);
        }
        return { showZero: true, showNegative: true, showPositive: true };
      }
    };

    // Filtering system with improved performance
    const FilterManager = {
      toggleFilter(filterId) {
        const checkbox = document.getElementById(filterId);
        if (checkbox) {
          checkbox.checked = !checkbox.checked;
          this.applyFilters();
        }
      },

      applyFilters() {
        // Use debounce with improved delay for better real-time feedback
        if (!this._debouncedApply) {
          this._debouncedApply = debounce(() => {
            const { showZero, showNegative, showPositive } = this.getFilterStates();

            const filteredData = AppState.currentFilteredData.filter(rowData => {
              switch (rowData.type) {
                case 'zero': return showZero;
                case 'negative': return showNegative;
                case 'positive': return showPositive;
                default: return false;
              }
            });

            // Update state for lazy loading
            AppState.totalFilteredRows = filteredData.length;
            AppState.displayedRows = 0;
            AppState.currentlyDisplayedData = filteredData;

            // Update visible count
            const visibleCountElement = document.getElementById('visibleCount');
            if (visibleCountElement) {
              visibleCountElement.textContent = filteredData.length;
            }

            // Re-render table with lazy loading (this will reset scroll position)
            LazyTableRenderer.renderInitial(filteredData, AppState.currentHeaders, AppState.currentTargetColumnIndex);
          }, CONFIG.DEBOUNCE_DELAY);
        }
        this._debouncedApply();
      },

      getFilterStates() {
        const showZero = document.getElementById('showZero')?.checked ?? true;
        const showNegative = document.getElementById('showNegative')?.checked ?? true;
        const showPositive = document.getElementById('showPositive')?.checked ?? true;
        
        return { showZero, showNegative, showPositive };
      },

      initialize() {
        const showZero = document.getElementById('showZero');
        const showNegative = document.getElementById('showNegative');
        const showPositive = document.getElementById('showPositive');

        // Restore saved filter state
        const saved = FilterPersistence.load();

        if (showZero) {
          showZero.checked = saved.showZero;
          showZero.addEventListener('change', () => {
            FilterPersistence.save(this.getFilterStates());
            this.applyFilters();
          });
        }
        if (showNegative) {
          showNegative.checked = saved.showNegative;
          showNegative.addEventListener('change', () => {
            FilterPersistence.save(this.getFilterStates());
            this.applyFilters();
          });
        }
        if (showPositive) {
          showPositive.checked = saved.showPositive;
          showPositive.addEventListener('change', () => {
            FilterPersistence.save(this.getFilterStates());
            this.applyFilters();
          });
        }
      }
    };

    // Validation summary generator with improved template handling
    const ValidationSummaryGenerator = {
      generate({ totalRows, zeroRows, negativeRows, positiveRows, invalidValues, filteredOutKg, columnName }) {
        const hasAnomalies = negativeRows > 0 || positiveRows > 0;
        const hasData = zeroRows > 0 || negativeRows > 0 || positiveRows > 0;
        
        return `
          <div class="mb-6">
            <div class="summary-header">
              <div class="summary-icon-wrapper">
                <svg fill="none" stroke="currentColor" stroke-width="1.75" viewBox="0 0 24 24" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
              </div>
              <h3 class="summary-title">Auswertung</h3>
            </div>
            ${this.generateStatsGrid({ totalRows, zeroRows, negativeRows, positiveRows, invalidValues, filteredOutKg })}
          </div>
          ${this.generateWarningsAndMessages({ invalidValues, filteredOutKg, hasAnomalies, columnName })}
        `;
      },

      generateStatsGrid({ totalRows, zeroRows, negativeRows, positiveRows, invalidValues, filteredOutKg }) {
        const statCards = [
          { label: 'Gesamt',          value: totalRows,     cardClass: 'stat-card--total' },
          { label: 'Normal',          value: zeroRows,      cardClass: 'stat-card--normal' },
          { label: 'Falschbuchungen', value: negativeRows,  cardClass: 'stat-card--falschbuchung' },
          { label: 'Genullt',         value: positiveRows,  cardClass: 'stat-card--genullt' },
          { label: 'Ungültige Werte', value: invalidValues, cardClass: 'stat-card--invalid' },
          { label: 'KG gefiltert',    value: filteredOutKg, cardClass: 'stat-card--kg' }
        ];
        const cardHtml = statCards.map(({ label, value, cardClass }) => `
          <div class="stat-card p-4 ${cardClass}">
            <div class="stat-card-label">${label}</div>
            <div class="stat-card-value">${value}</div>
          </div>
        `).join('');

        return `
          <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-3 mb-5">
            ${cardHtml}
          </div>
          <div class="stats-panel">
            <div class="flex flex-col lg:flex-row lg:items-start lg:justify-between gap-5">
              <div class="flex-1">
                <div class="filter-section-header">
                  <svg class="filter-section-icon" fill="none" stroke="currentColor" stroke-width="1.75" viewBox="0 0 24 24" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"/></svg>
                  <span class="filter-section-label">Filteroptionen</span>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                  <label class="filter-card filter-emerald">
                    <input type="checkbox" id="showZero" class="filter-checkbox" checked aria-label="Normal-Einträge anzeigen">
                    <div class="filter-card-content">
                      <div class="flex items-center justify-between">
                        <div class="filter-label-inner">
                          <div class="filter-dot"></div>
                          <div>
                            <div class="filter-type-name">Normal</div>
                            <div class="filter-type-count">${zeroRows} Einträge</div>
                          </div>
                        </div>
                        <div class="filter-checkmark">
                          <svg fill="currentColor" viewBox="0 0 20 20" aria-hidden="true"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>
                        </div>
                      </div>
                    </div>
                  </label>
                  <label class="filter-card filter-red">
                    <input type="checkbox" id="showNegative" class="filter-checkbox" checked aria-label="Falschbuchungen anzeigen">
                    <div class="filter-card-content">
                      <div class="flex items-center justify-between">
                        <div class="filter-label-inner">
                          <div class="filter-dot"></div>
                          <div>
                            <div class="filter-type-name">Falschbuchungen</div>
                            <div class="filter-type-count">${negativeRows} Einträge</div>
                          </div>
                        </div>
                        <div class="filter-checkmark">
                          <svg fill="currentColor" viewBox="0 0 20 20" aria-hidden="true"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>
                        </div>
                      </div>
                    </div>
                  </label>
                  <label class="filter-card filter-blue">
                    <input type="checkbox" id="showPositive" class="filter-checkbox" checked aria-label="Genullt-Einträge anzeigen">
                    <div class="filter-card-content">
                      <div class="flex items-center justify-between">
                        <div class="filter-label-inner">
                          <div class="filter-dot"></div>
                          <div>
                            <div class="filter-type-name">Genullt</div>
                            <div class="filter-type-count">${positiveRows} Einträge</div>
                          </div>
                        </div>
                        <div class="filter-checkmark">
                          <svg fill="currentColor" viewBox="0 0 20 20" aria-hidden="true"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>
                        </div>
                      </div>
                    </div>
                  </label>
                </div>
              </div>
              <div class="flex-shrink-0">
                <div class="results-chip text-center">
                  <div class="results-chip-label">Ergebnisse</div>
                  <div class="results-chip-count">
                    <span id="visibleCount">${zeroRows + negativeRows + positiveRows}</span>
                    <span class="results-separator"> / </span>
                    <span id="totalCount" class="results-total">${zeroRows + negativeRows + positiveRows}</span>
                  </div>
                  <div class="results-footer">Datensätze</div>
                </div>
              </div>
            </div>
          </div>
        `;
      },

      generateWarningsAndMessages({ invalidValues, filteredOutKg, hasAnomalies, columnName }) {
        let html = '';
        
        const infoBlock = (typeClass, iconPath, text) => `
          <div class="notification-bar mt-3 ${typeClass}">
            <div class="info-block-content">
              <svg class="info-block-icon" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" d="${iconPath}"/></svg>
              <p class="info-block-text">${text}</p>
            </div>
          </div>
        `;

        if (filteredOutKg > 0) {
          html += infoBlock(
            'notification-bar--purple',
            'M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z',
            `Information: ${filteredOutKg} Zeilen mit KG-Einheiten wurden automatisch ausgefiltert (KG-Messungen haben typischerweise natürliche Schwankungen)`
          );
        }
        
        if (invalidValues > 0) {
          html += infoBlock(
            'notification-bar--warning',
            'M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z',
            `Warnung: ${invalidValues} ungültige numerische Werte in Spalte &#39;${columnName}&#39; gefunden`
          );
        }
        
        if (!hasAnomalies) {
          html += infoBlock(
            'notification-bar--success',
            'M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z',
            `Alles in Ordnung: Keine Falschbuchungen oder Genullt in Spalte &#39;${columnName}&#39; gefunden. Alle Werte sind normal.`
          );
        }
        
        return html;
      }
    };

    // Shared DOM-building and styling helpers used by both renderers
    const TableDOMHelper = {
      /** Returns the CSS row class for a given row type. */
      rowClass(type) {
        const map = {
          zero:     'table-row table-row--zero',
          negative: 'table-row table-row--negative',
          positive: 'table-row table-row--positive',
        };
        return map[type] ?? 'table-row';
      },

      /** Returns the CSS highlight class for the target column cell. */
      highlightClass(type) {
        const map = {
          zero:     'table-td--highlight-zero',
          negative: 'table-td--highlight-negative',
          positive: 'table-td--highlight-positive',
        };
        return map[type] ?? '';
      },

      /** Creates a fully-styled <table> element. */
      createTable() {
        const table = document.createElement('table');
        table.className = 'w-full text-xs sm:text-sm';
        table.setAttribute('role', 'table');
        table.setAttribute('aria-label', 'Anomaliedaten-Tabelle');
        return table;
      },

      /** Creates a <thead> from an array of header strings. */
      createHeader(headers) {
        const thead = document.createElement('thead');
        const headerRow = document.createElement('tr');
        headerRow.setAttribute('role', 'row');
        headerRow.className = 'table-header-row';

        headers.forEach((header) => {
          const th = document.createElement('th');
          th.className = 'table-th';
          th.textContent = header;
          th.setAttribute('scope', 'col');
          headerRow.appendChild(th);
        });

        thead.appendChild(headerRow);
        return thead;
      },

      /** Creates a fully-styled <tr> for a single data row. */
      createRow(rowData, headers, targetColumnIndex) {
        const tr = document.createElement('tr');
        tr.setAttribute('role', 'row');
        tr.className = this.rowClass(rowData.type);

        rowData.cells.forEach((cell, index) => {
          const td = document.createElement('td');
          const isNumber = !isNaN(parseFloat(cell.replace(',', '.')));
          td.className = 'table-td' + (isNumber ? ' table-td--number' : '');

          if (index === targetColumnIndex) {
            const hl = this.highlightClass(rowData.type);
            if (hl) td.classList.add(hl);
            td.setAttribute('aria-label', `${headers[index]}: ${cell}`);
          }

          td.textContent = cell;
          td.setAttribute('role', 'cell');
          td.setAttribute('title', cell);
          tr.appendChild(td);
        });

        return tr;
      },

      /** Shows the table wrapper and clears/shows or hides with an empty-state message. */
      renderEmptyOrShow(output, tableWrapper, isEmpty) {
        if (isEmpty) {
          output.innerHTML = '<p class="table-empty-message">Keine Anomalien entsprechen den aktuellen Filtereinstellungen.</p>';
        }
        if (tableWrapper) {
          tableWrapper.classList.remove('hidden');
        }
      },
    };

    // Table rendering with improved performance and accessibility
    const TableRenderer = {
      render(filteredData, headers, targetColumnIndex) {
        const output = document.getElementById('output');
        const tableWrapper = document.getElementById('tableWrapper');
        if (!output) return;

        output.innerHTML = '';

        if (filteredData.length === 0) {
          TableDOMHelper.renderEmptyOrShow(output, tableWrapper, true);
          return;
        }

        const table = TableDOMHelper.createTable();
        table.appendChild(TableDOMHelper.createHeader(headers));
        table.appendChild(this.createBody(filteredData, headers, targetColumnIndex));

        output.appendChild(table);
        TableDOMHelper.renderEmptyOrShow(output, tableWrapper, false);
      },

      createBody(filteredData, headers, targetColumnIndex) {
        const tbody = document.createElement('tbody');
        filteredData.forEach((rowData) => {
          tbody.appendChild(TableDOMHelper.createRow(rowData, headers, targetColumnIndex));
        });
        return tbody;
      },

      // Expose style helpers so external callers (LazyTableRenderer) can reference them
      getRowStyle(type)      { return { rowClass: TableDOMHelper.rowClass(type) }; },
      getHighlightStyle(type) { return TableDOMHelper.highlightClass(type); },
    };

    // Lazy Table Renderer for improved performance with large datasets
    const LazyTableRenderer = {
      table: null,
      tbody: null,
      headers: null,
      targetColumnIndex: -1,
      loadingIndicator: null,
      intersectionObserver: null,
      sentinel: null,

      renderInitial(filteredData, headers, targetColumnIndex) {
        this.headers = headers;
        this.targetColumnIndex = targetColumnIndex;

        this.resetLazyLoader();

        const output = document.getElementById('output');
        const tableWrapper = document.getElementById('tableWrapper');
        if (!output) return;

        output.innerHTML = '';

        if (filteredData.length === 0) {
          TableDOMHelper.renderEmptyOrShow(output, tableWrapper, true);
          return;
        }

        this.table = TableDOMHelper.createTable();
        this.table.appendChild(TableDOMHelper.createHeader(headers));
        this.tbody = document.createElement('tbody');
        this.tbody.id = 'lazyTableBody';
        this.table.appendChild(this.tbody);

        this.createLoadingIndicator();

        output.appendChild(this.table);
        output.appendChild(this.loadingIndicator);
        TableDOMHelper.renderEmptyOrShow(output, tableWrapper, false);

        this.loadMoreRows(Math.min(CONFIG.INITIAL_LOAD, filteredData.length));
        this.setupIntersectionObserver();
      },

      resetLazyLoader() {
        if (this.intersectionObserver) {
          this.intersectionObserver.disconnect();
          this.intersectionObserver = null;
        }
        if (this.sentinel && this.sentinel.parentNode) {
          this.sentinel.parentNode.removeChild(this.sentinel);
          this.sentinel = null;
        }
        AppState.displayedRows = 0;
        AppState.isLoading = false;
        if (this.tbody) {
          this.tbody.innerHTML = '';
        }
      },

      createLoadingIndicator() {
        this.loadingIndicator = document.createElement('div');
        this.loadingIndicator.id = 'loadingIndicator';
        this.loadingIndicator.className = 'loading-indicator hidden';
        this.loadingIndicator.innerHTML = `
          <div class="loading-indicator-inner">
            <svg class="animate-spin loading-indicator-icon" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
            </svg>
            Weitere Zeilen werden geladen…
          </div>
        `;
      },

      loadMoreRows(count) {
        if (AppState.isLoading || AppState.displayedRows >= AppState.totalFilteredRows) return;

        AppState.isLoading = true;
        this.showLoadingIndicator();

        const loadDelay = CONFIG.LAZY_LOAD_DELAY;
        if (loadDelay > 0) {
          setTimeout(() => this.performRowLoading(count), loadDelay);
        } else {
          this.performRowLoading(count);
        }
      },

      performRowLoading(count) {
        const start = AppState.displayedRows;
        const end = Math.min(start + count, AppState.totalFilteredRows);
        const rowsToAdd = AppState.currentlyDisplayedData.slice(start, end);

        rowsToAdd.forEach((rowData) => {
          this.tbody.appendChild(
            TableDOMHelper.createRow(rowData, this.headers, this.targetColumnIndex)
          );
        });

        AppState.displayedRows = end;
        AppState.isLoading = false;
        this.hideLoadingIndicator();
        this.updateProgressIndicator();

        Logger.debug(`Loaded rows ${start + 1}-${end} of ${AppState.totalFilteredRows}`);
      },

      setupIntersectionObserver() {
        if (this.intersectionObserver) {
          this.intersectionObserver.disconnect();
          this.intersectionObserver = null;
        }
        if (this.sentinel && this.sentinel.parentNode) {
          this.sentinel.parentNode.removeChild(this.sentinel);
          this.sentinel = null;
        }

        this.sentinel = document.createElement('div');
        this.sentinel.id = 'loadSentinel';
        this.sentinel.className = 'h-1';

        this.intersectionObserver = new IntersectionObserver((entries) => {
          entries.forEach(entry => {
            if (entry.isIntersecting && !AppState.isLoading && AppState.displayedRows < AppState.totalFilteredRows) {
              this.loadMoreRows(CONFIG.ROWS_PER_PAGE);
            }
          });
        }, {
          rootMargin: CONFIG.getIntersectionMargin(),
        });

        this.loadingIndicator.parentNode.insertBefore(this.sentinel, this.loadingIndicator);
        this.intersectionObserver.observe(this.sentinel);
      },

      showLoadingIndicator() {
        if (this.loadingIndicator) this.loadingIndicator.classList.remove('hidden');
      },

      hideLoadingIndicator() {
        if (this.loadingIndicator) this.loadingIndicator.classList.add('hidden');
      },

      updateProgressIndicator() {
        const visibleCountElement = document.getElementById('visibleCount');
        if (visibleCountElement) {
          visibleCountElement.textContent = `${AppState.displayedRows} von ${AppState.totalFilteredRows}`;
        }
      },

      cleanup() {
        if (this.intersectionObserver) {
          this.intersectionObserver.disconnect();
          this.intersectionObserver = null;
        }
        if (this.sentinel && this.sentinel.parentNode) {
          this.sentinel.parentNode.removeChild(this.sentinel);
          this.sentinel = null;
        }
      }
    };
    
    
    // File processor with improved error handling and performance
    const FileProcessor = {
      async processFile(rawData) {
        NotificationManager.show('Datei wird verarbeitet…', NOTIFICATION_TYPES.PROCESSING, 0);
        
        try {
          // Clear previous results
          this.clearResults();
          
          // Parse and validate HTML content
          const doc = await this.parseAndValidateHtml(rawData);
          
          // Extract and process table data
          const { headers, targetColumnIndex, stats, filteredData } = this.processTableData(doc);
          
          // Update state
          this.updateApplicationState(filteredData, headers, targetColumnIndex);
          
          // Update UI
          this.updateValidationSummary(stats);
          
          if (stats.negativeRows === 0 && stats.positiveRows === 0) {
            NotificationManager.show('Keine Falschbuchungen oder Genullt gefunden – alle Werte sind normal.', NOTIFICATION_TYPES.INFO);
            return;
          }
          
          // Apply filters
          FilterManager.applyFilters();
          
          NotificationManager.show(
            `${stats.negativeRows} Falschbuchungen und ${stats.positiveRows} Genullt gefunden (${stats.zeroRows} normale Werte).`,
            NOTIFICATION_TYPES.SUCCESS
          );
          
        } catch (error) {
          this.handleProcessingError(error);
          throw error;
        }
      },

      clearResults() {
        const output = document.getElementById('output');
        const validationSummary = document.getElementById('validationSummary');
        const validationWrapper = document.getElementById('validationWrapper');
        const tableWrapper = document.getElementById('tableWrapper');
        
        // Scroll to top only on new file load, not on filter changes
        window.scrollTo(0, 0);

        // Clean up lazy table renderer
        LazyTableRenderer.cleanup();
        
        if (output) {
          output.innerHTML = '';
        }
        if (validationSummary) {
          validationSummary.innerHTML = '';
        }
        if (validationWrapper) {
          validationWrapper.classList.add('hidden');
        }
        if (tableWrapper) {
          tableWrapper.classList.add('hidden');
        }
      },

      async parseAndValidateHtml(rawData) {
        // Find the HTML content section in MHTML
        const htmlStart = rawData.indexOf('<html');
        
        if (htmlStart === -1) {
          throw new Error('Kein HTML-Inhalt in der Datei gefunden. Bitte stellen Sie sicher, dass es sich um eine gültige MHTML-Datei handelt.');
        }
        
        const htmlContent = rawData.substring(htmlStart);
        
        // Sanitize and parse the HTML content
        const sanitizedHtml = DOMPurify.sanitize(htmlContent, {
          WHOLE_DOCUMENT: true,
          RETURN_DOM: false,
          USE_PROFILES: { html: true, svg: false, svgFilters: false }
        });
        
        const parser = new DOMParser();
        const doc = parser.parseFromString(sanitizedHtml, 'text/html');
        
        if (!doc.querySelector('table') && !doc.querySelector('tr')) {
          throw new Error('Ungültiges Dateiformat: Nach der Bereinigung wurden keine Tabellendaten gefunden.');
        }

        return doc;
      },

      processTableData(doc) {
        const rows = doc.querySelectorAll('tr');
        if (!rows.length) {
          throw new Error('Keine Tabellendaten gefunden.');
        }

        // Extract headers and remove the last column
        const allHeaders = Array.from(rows[0].querySelectorAll('td')).map(td => td.textContent.trim());
        const headers = allHeaders.slice(0, -1); // Remove last column
        
        // Find required columns
        const targetColumnIndex = headers.indexOf(CONFIG.DELIVERED_QUANTITY_COLUMN);
        if (targetColumnIndex === -1) {
          throw new Error(`Erforderliche Spalte '${CONFIG.DELIVERED_QUANTITY_COLUMN}' wurde nicht in der Datei gefunden.`);
        }

        // Find unit column for KG filtering
        const unitColumnIndex = headers.indexOf('Einh. L/A');
        if (unitColumnIndex !== -1) {
          Logger.info(`Found unit column 'Einh. L/A' at index ${unitColumnIndex} - will filter out KG entries`);
        }

        // Process data rows and collect stats
        const stats = { totalRows: 0, zeroRows: 0, negativeRows: 0, positiveRows: 0, invalidValues: 0, filteredOutKg: 0 };
        
        const filteredData = Array.from(rows)
          .slice(1)
          .map(row => {
            stats.totalRows++;
            const allCells = Array.from(row.querySelectorAll('td')).map(td => td.textContent.trim());
            const cells = allCells.slice(0, -1); // Remove last column data
            
            if (!cells[targetColumnIndex]) {
              return null;
            }
            
            // Check if this row contains KG units and should be filtered out
            const containsKgUnit = this.shouldFilterOutKgRow(allCells, unitColumnIndex);
            if (containsKgUnit) {
              stats.filteredOutKg++;
              return null; // Filter out KG rows
            }
            
            const value = parseFloat(cells[targetColumnIndex].replace(',', '.'));
            if (isNaN(value)) {
              stats.invalidValues++;
              return null;
            }
            
            if (value === 0) {
              stats.zeroRows++;
              return { cells, type: 'zero' }; // Include zero values for filtering
            } else if (value < 0) {
              stats.negativeRows++;
              return { cells, type: 'negative' };
            } else if (value > 0) {
              stats.positiveRows++;
              return { cells, type: 'positive' };
            }
            
            return null;
          })
          .filter(row => row !== null);

        return { headers, targetColumnIndex, stats, filteredData };
      },

      shouldFilterOutKgRow(cells, unitColumnIndex) {
        // If we found the unit column, check it specifically
        if (unitColumnIndex !== -1 && cells[unitColumnIndex]) {
          const unitCell = cells[unitColumnIndex].toLowerCase().trim();
          return CONFIG.FILTER_OUT_UNITS.some(unit => {
            const unitLower = unit.toLowerCase();
            return unitCell === unitLower || 
                   unitCell.includes(unitLower) ||
                   unitCell.startsWith(unitLower) ||
                   unitCell.endsWith(unitLower);
          });
        }
        
        // Fallback: check all cells if unit column not found
        return cells.some(cell => {
          if (typeof cell !== 'string') return false;
          const cellLower = cell.toLowerCase();
          return CONFIG.FILTER_OUT_UNITS.some(unit => {
            const unitLower = unit.toLowerCase();
            // Check for unit at end of string (with optional space/punctuation)
            return cellLower.endsWith(unitLower) || 
                   cellLower.endsWith(` ${unitLower}`) ||
                   cellLower.includes(`${unitLower} `) ||
                   cellLower.includes(` ${unitLower}`) ||
                   // Check for patterns like "5,2 kg" or "5.2kg"
                   /[\d\s,\.]\s*kg\s*$/i.test(cell) ||
                   /^kg\s*[\d\s,\.]/i.test(cell);
          });
        });
      },

      updateApplicationState(filteredData, headers, targetColumnIndex) {
        AppState.currentFilteredData = filteredData;
        AppState.currentHeaders = headers;
        AppState.currentTargetColumnIndex = targetColumnIndex;
      },

      updateValidationSummary(stats) {
        const validationSummary = document.getElementById('validationSummary');
        const validationWrapper = document.getElementById('validationWrapper');
        if (validationSummary && validationWrapper) {
          validationSummary.innerHTML = DOMPurify.sanitize(
            ValidationSummaryGenerator.generate({
              ...stats,
              columnName: CONFIG.DELIVERED_QUANTITY_COLUMN
            })
          );
          
          // Show the validation wrapper when content is added
          validationWrapper.classList.remove('hidden');
          
          // Initialize filters after the HTML is inserted
          FilterManager.initialize();
        }
      },

      handleProcessingError(error) {
        const validationSummary = document.getElementById('validationSummary');
        if (validationSummary) {
          validationSummary.innerHTML = DOMPurify.sanitize(`
            <div class="bg-red-50 border-l-4 border-red-400 p-4 text-red-700">
              <p class="font-bold">Fehler beim Verarbeiten der Datei</p>
              <p>${error.message}</p>
            </div>
          `);
        }
        
        NotificationManager.show(`Fehler beim Verarbeiten der Datei: ${error.message}`, NOTIFICATION_TYPES.ERROR);
      }
    };
    // Event listeners setup with improved organization
    const EventListenerSetup = {
      init() {
        this.setupFileSelection();
        this.setupProcessFile();
        this.setupKeyboardAccessibility();
        this.setupDragAndDrop();
      },

      setupFileSelection() {
        const selectFileButton = document.getElementById('selectFileButton');
        const fileInput = document.getElementById('fileInput');
        
        if (selectFileButton && fileInput) {
          selectFileButton.addEventListener('click', () => {
            if (isSupported()) {
              EventHandlers.handleFileSelection();
            } else {
              fileInput.click();
            }
          });
          
          fileInput.addEventListener('change', (e) => {
            EventHandlers.handleFileInputChange(e);
          });
        }
      },

      setupProcessFile() {
        const processFileButton = document.getElementById('processFileButton');
        if (processFileButton) {
          processFileButton.addEventListener('click', EventHandlers.handleProcessFile);
        }
      },

      setupDragAndDrop() {
        const selectFileButton = document.getElementById('selectFileButton');
        if (selectFileButton) {
          selectFileButton.addEventListener('dragover', (e) => {
            e.preventDefault();
            selectFileButton.classList.add('drag-over');
          });
          
          selectFileButton.addEventListener('dragleave', (e) => {
            e.preventDefault();
            selectFileButton.classList.remove('drag-over');
          });
          
          selectFileButton.addEventListener('drop', (e) => {
            e.preventDefault();
            selectFileButton.classList.remove('drag-over');
            
            const files = e.dataTransfer.files;
            if (files.length > 0 && (files[0].name.endsWith('.mhtml') || files[0].name.endsWith('.mht'))) {
              EventHandlers.updateFileSelection(files[0].name);
              FileHandler.handleSelectedFile(files[0]);
            }
          });
        }
      },

      setupKeyboardAccessibility() {
        // Add keyboard support for custom button-like elements only
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' ') {
            const target = e.target;
            // Only handle custom elements with role="button", exclude native interactive elements
            if (target.getAttribute('role') === 'button' && 
                target.hasAttribute('tabindex') &&
                !['BUTTON', 'INPUT', 'SELECT', 'TEXTAREA', 'A'].includes(target.tagName)) {
              e.preventDefault();
              target.click();
            }
          }
        });
      }
    };

    // Legacy function support for backward compatibility
    const toggleFilter = (filterId) => FilterManager.toggleFilter(filterId);

    // Initialize everything when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        EventListenerSetup.init();
        Logger.info('Application initialized successfully');
      });
    } else {
      EventListenerSetup.init();
      Logger.info('Application initialized successfully');
    }
  </script>
</body>
</html>
